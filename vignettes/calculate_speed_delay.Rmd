---
title: "Calculate Speed and Delay"
author: Liz Roten
output: rmarkdown::html_vignette
bibliography: references.bib
csl: apa-single-spaced.csl
nocite: '@*'
vignette: >
  %\VignetteIndexEntry{Calculate Speed and Delay}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = FALSE,
  warning = FALSE,
  message = FALSE
)

options(scipen = 9999)
```

## Aggregate hourly speed  

First, we will pull the data for three random sensors from January 1 to January 15, 2019. 

```{r, cache=TRUE}
library(tc.sensors)
library(tictoc)
library(dplyr)
library(furrr)

sensor_config <- pull_configuration() %>% 
  dplyr::filter(corridor_route == "T.H.610",
                r_node_n_type == "Station",
                detector_category == "") 

date_range <- seq(as.Date("2019/03/03"), as.Date("2019/03/16"), by = "days")

plan(multiprocess)

tic() # Start the timer
sensor_data <- future_map(sensor_config$detector_name,
                              .f = function(det_name){
                                future_map_dfr(seq(1:length(date_range)), .f = function(x){
                                  tc.sensors::pull_sensor(det_name, date_range[[x]])
                                })
                              })
toc()
```


Clean data
```{r}
library(purrr)
clean_sensor_data <- purrr::map(sensor_data,
                                scrub_sensor, 
                                interval_length = NA) %>% # replace 
```

## Calculate delay  

*Delay* is the difference in the time it takes to traverse a given distance at the reference speed and the comparison speed. Reference speed is typically the speed during free-flow periods. Delay is highly dependent on the reference speed.  

>The use of free-flow speeds as a benchmark is understandable since it can be seen as a replicable and readily useable “objective” figure. Problems arise, however, when the difference between free flow speeds and experienced speeds are labelled “delay”. Delay is the technically correct term for the difference but is often semantically misconstrued as referring to an attainable target for peak hour travel – e.g. “zero-delay”. It should be noted that, most dynamic cities cannot afford to deliver free-flow speeds at peak hours, nor would they want to live with a road network that could deliver these speeds at peak hours. Discourse based on delay as measured in reference to free-flow travel times can thus be biased towards an unattainable and likely undesirable congestion management goal (e.g. zero delay). In this case, the use of an outcome neutral indicators or indices is preferable.  - *@world_bank_cairo_2013, Annex 9*

To calculate the amount of time (in hours) it takes to traverse a given distance, we need to know the distance length (in miles) and the speed (in miles per hour). 

$Time = \frac{Distance}{Speed}$

We can safely assume that the distance between sensors is 0.5 miles. 

```{r}
agg_ten <- purrr::map(clean_sensor_data, 
                       aggregate_sensor_data,
                       config = sensor_config,
                       interval_length = 10/60) %>% 
  purrr::map(replace_impossible, interval_length = 10/60) %>% 
  purrr::map(add_day_type)

agg_hour <- purrr::map(clean_sensor_data, 
                       aggregate_sensor_data,
                       config = sensor_config,
                       interval_length = 1) %>% 
  purrr::map_dfr(replace_impossible, interval_length = 1) %>% 
    filter(speed < 100)


trav <- map(agg_ten, mutate,
            travel_time = 0.5/speed,
            travel_time_min = travel_time*60) %>% 
  map_dfr(left_join, sensor_config,
          by  = c("sensor" = "detector_name")) %>% 
  filter(speed < 100)

summary(trav$speed)
summary(agg_hour$speed)
```

```{r}
library(ggplot2)

ggplot(trav)+
  geom_density(aes(x = speed
                   # fill = day_type,
                   # color = day_type
                   )) +
  facet_wrap(~day_of_week) +
  theme_minimal()
```



## Relevant reports and references  

<div id="refs"></div>

<footer>
*Last updated by Liz Roten, `r Sys.Date()`*
</footer>
